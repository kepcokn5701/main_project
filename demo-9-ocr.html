<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>산업안전보건관리비 OCR 검증 시스템</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { font-family: 'Noto Sans KR', sans-serif; }
  body { background: #070b16; }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #0d1525; }
  ::-webkit-scrollbar-thumb { background: #1e3a4a; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #2a5a6a; }

  @keyframes scanLine {
    0% { top: 0; opacity: 1; }
    100% { top: 100%; opacity: 0.3; }
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 5px rgba(20,184,166,0.3); }
    50% { box-shadow: 0 0 20px rgba(20,184,166,0.6); }
  }
  @keyframes highlightBox {
    0% { opacity: 0; transform: scale(0.95); }
    50% { opacity: 1; transform: scale(1.02); }
    100% { opacity: 0.8; transform: scale(1); }
  }
  @keyframes progressFill {
    from { width: 0%; }
    to { width: 100%; }
  }
  @keyframes typing {
    from { width: 0; }
    to { width: 100%; }
  }
  @keyframes blink {
    50% { border-color: transparent; }
  }
  @keyframes qrReveal {
    from { opacity: 0; transform: scale(0.8) rotate(-5deg); }
    to { opacity: 1; transform: scale(1) rotate(0deg); }
  }
  @keyframes checkmarkDraw {
    from { stroke-dashoffset: 50; }
    to { stroke-dashoffset: 0; }
  }
  @keyframes slideInRight {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes dotPulse {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
  }

  .scan-line {
    position: absolute;
    left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, #14b8a6, #10b981, #14b8a6, transparent);
    box-shadow: 0 0 15px #14b8a6, 0 0 30px rgba(20,184,166,0.3);
    z-index: 10;
    animation: scanLine 2.5s ease-in-out infinite;
  }

  .ocr-highlight {
    position: absolute;
    border: 2px solid #14b8a6;
    background: rgba(20,184,166,0.08);
    border-radius: 3px;
    animation: highlightBox 0.5s ease forwards;
  }

  .fade-in-up {
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
  }

  .slide-in-right {
    animation: slideInRight 0.4s ease forwards;
    opacity: 0;
  }

  .card {
    background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
    border: 1px solid rgba(20,184,166,0.15);
    backdrop-filter: blur(10px);
  }

  .card:hover {
    border-color: rgba(20,184,166,0.3);
  }

  .drop-zone {
    border: 2px dashed rgba(20,184,166,0.3);
    transition: all 0.3s ease;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: #14b8a6;
    background: rgba(20,184,166,0.05);
  }

  .sample-doc {
    transition: all 0.2s ease;
    cursor: pointer;
  }
  .sample-doc:hover {
    background: rgba(20,184,166,0.1);
    border-color: rgba(20,184,166,0.4);
    transform: translateY(-2px);
  }
  .sample-doc.active {
    background: rgba(20,184,166,0.15);
    border-color: #14b8a6;
  }

  .receipt-mock {
    background: linear-gradient(180deg, #f8f9fa, #e9ecef);
    color: #1a1a2e;
    position: relative;
    overflow: hidden;
  }

  .qr-grid {
    display: grid;
    grid-template-columns: repeat(15, 1fr);
    gap: 1px;
  }
  .qr-cell {
    aspect-ratio: 1;
    border-radius: 1px;
  }

  .editable-field {
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px dashed transparent;
  }
  .editable-field:hover {
    border-bottom-color: #14b8a6;
    color: #14b8a6;
  }
  .editable-field input {
    background: rgba(20,184,166,0.1);
    border: 1px solid #14b8a6;
    color: #e2e8f0;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: inherit;
    width: 100%;
    outline: none;
  }

  .status-badge {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 9999px;
    font-weight: 500;
  }

  .progress-bar-fill {
    transition: width 0.8s ease;
  }

  .loading-dots span {
    animation: dotPulse 1.4s infinite;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

  .nav-btn {
    transition: all 0.2s;
  }
  .nav-btn:hover {
    background: rgba(20,184,166,0.15);
  }
</style>
</head>
<body class="min-h-screen text-gray-200">
<!-- AI DATA DISCLAIMER START (AI기본법 준수) -->
<div id="ai-disclaimer-banner" style="position:fixed;top:0;left:0;right:0;z-index:99999;background:linear-gradient(135deg,#78350f,#92400e);border-bottom:2px solid #f59e0b;padding:8px 20px;display:flex;align-items:center;justify-content:center;gap:10px;font-family:Noto Sans KR,sans-serif;font-size:13px;color:#fef3c7;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,.6);"><span style="font-size:18px;">&#x26A0;&#xFE0F;</span><span><strong style="color:#fde68a;">AI 생성 데이터 고지</strong> | 본 화면의 모든 데이터(성명, 연락처, 주소, 계량값, 요금 등)는 <strong style="text-decoration:underline;">AI가 생성한 가상 데이터</strong>이며, 실제 인물 기업 고객 정보와 일절 무관합니다. <span style="opacity:.75;">(AI기본법 준수)</span></span></div>
<div id="ai-disclaimer-spacer" style="height:40px;"></div>
<div id="ai-watermark" style="position:fixed;bottom:14px;right:14px;z-index:99998;background:rgba(120,53,15,.92);border:1px solid rgba(251,191,36,.45);border-radius:24px;padding:6px 16px;font-family:Noto Sans KR,sans-serif;font-size:11px;color:#fde68a;display:flex;align-items:center;gap:6px;backdrop-filter:blur(6px);box-shadow:0 4px 12px rgba(0,0,0,.4);pointer-events:none;">&#x1F916; AI 생성 가상 데이터</div>
<div id="ai-consent-overlay" style="position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;font-family:Noto Sans KR,sans-serif;"><div style="background:linear-gradient(145deg,#1a1a2e,#16213e);border:1px solid rgba(251,191,36,.3);border-radius:20px;padding:36px 32px;max-width:520px;width:90%;text-align:center;box-shadow:0 24px 48px rgba(0,0,0,.6);"><div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#92400e,#b45309);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:32px;">&#x26A0;&#xFE0F;</div><h2 style="color:#fde68a;font-size:20px;font-weight:700;margin-bottom:12px;">AI 생성 데이터 안내</h2><p style="color:#cbd5e1;font-size:14px;line-height:1.8;margin-bottom:8px;">본 시스템은 <strong style="color:#fbbf24;">프로토타입 시연 목적</strong>으로 제작되었습니다.</p><div style="background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:12px;padding:16px;margin:16px 0;text-align:left;"><p style="color:#fef3c7;font-size:13px;line-height:1.8;">&#x2022; 화면에 표시되는 <strong style="color:#fbbf24;">모든 데이터는 AI가 생성한 가상 데이터</strong>입니다.<br>&#x2022; 실제 인물, 기업, 고객, 설비 정보와 <strong style="color:#fbbf24;">일절 무관</strong>합니다.<br>&#x2022; 이름, 연락처, 주소, 계기번호, 요금 등 모든 수치는 허구입니다.<br>&#x2022; 본 고지는 <strong style="color:#fbbf24;">AI기본법</strong>을 준수합니다.</p></div><button onclick="document.getElementById('ai-consent-overlay').style.display='none';" style="background:linear-gradient(135deg,#b45309,#d97706);color:#fff;border:none;padding:12px 48px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:Noto Sans KR,sans-serif;box-shadow:0 4px 16px rgba(217,119,6,.4);transition:transform .15s;">확인했습니다</button><p style="color:#64748b;font-size:11px;margin-top:14px;">이 안내를 확인해야 시스템을 이용하실 수 있습니다.</p></div></div>
<!-- AI DATA DISCLAIMER END -->

<!-- Top Navigation -->
<nav class="sticky top-0 z-50 border-b border-teal-900/30" style="background:rgba(7,11,22,0.95); backdrop-filter:blur(12px);">
  <div class="max-w-[1600px] mx-auto px-6 h-14 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="index.html" class="nav-btn flex items-center gap-2 text-sm text-gray-400 hover:text-teal-400 px-3 py-1.5 rounded-lg">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span>돌아가기</span>
      </a>
      <div class="h-5 w-px bg-gray-700"></div>
      <div class="flex items-center gap-2.5">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-teal-500 to-emerald-600 flex items-center justify-center">
          <i data-lucide="scan-text" class="w-4 h-4 text-white"></i>
        </div>
        <div>
          <h1 class="text-sm font-semibold text-white leading-tight">산업안전보건관리비 OCR</h1>
          <p class="text-[10px] text-gray-500 leading-tight">문서 자동 인식 및 검증 시스템</p>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-2 text-xs text-gray-500 bg-gray-800/50 px-3 py-1.5 rounded-full">
        <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
        <span>OCR 엔진 활성</span>
      </div>
      <div class="text-xs text-gray-500 bg-gray-800/50 px-3 py-1.5 rounded-full">
        <span>평균 처리속도: </span>
        <span class="text-teal-400 font-semibold" id="avgSpeed">3.2초/건</span>
      </div>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="max-w-[1600px] mx-auto px-6 py-6">

  <!-- Upload Section (Initial State) -->
  <div id="uploadSection">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Upload Zone -->
      <div class="lg:col-span-2">
        <div class="card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-base font-semibold text-white flex items-center gap-2">
              <i data-lucide="upload-cloud" class="w-5 h-5 text-teal-400"></i>
              문서 업로드
            </h2>
            <span class="text-xs text-gray-500">영수증, 세금계산서, 사진 지원</span>
          </div>

          <div id="dropZone" class="drop-zone rounded-xl p-12 text-center cursor-pointer"
               ondragover="event.preventDefault(); this.classList.add('drag-over')"
               ondragleave="this.classList.remove('drag-over')"
               ondrop="event.preventDefault(); this.classList.remove('drag-over')"
               onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
            <div class="flex flex-col items-center gap-4">
              <div class="w-16 h-16 rounded-2xl bg-teal-500/10 flex items-center justify-center">
                <i data-lucide="file-scan" class="w-8 h-8 text-teal-400"></i>
              </div>
              <div>
                <p class="text-sm text-gray-300 font-medium mb-1">파일을 드래그하거나 클릭하여 업로드</p>
                <p class="text-xs text-gray-500">PDF, JPG, PNG 파일 지원 | 최대 50MB</p>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <span class="px-3 py-1 rounded-full text-[10px] bg-teal-500/10 text-teal-400 border border-teal-500/20">영수증</span>
                <span class="px-3 py-1 rounded-full text-[10px] bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">세금계산서</span>
                <span class="px-3 py-1 rounded-full text-[10px] bg-cyan-500/10 text-cyan-400 border border-cyan-500/20">거래명세서</span>
                <span class="px-3 py-1 rounded-full text-[10px] bg-blue-500/10 text-blue-400 border border-blue-500/20">사진</span>
              </div>
            </div>
          </div>

          <!-- Sample Documents -->
          <div class="mt-5">
            <p class="text-xs text-gray-500 mb-3 flex items-center gap-1.5">
              <i data-lucide="file-text" class="w-3.5 h-3.5"></i>
              샘플 문서로 테스트
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3" id="sampleDocs">
              <div class="sample-doc border border-gray-700/50 rounded-xl p-4 flex items-center gap-3" data-doc="0" onclick="selectSampleDoc(0)">
                <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center flex-shrink-0">
                  <i data-lucide="file-text" class="w-5 h-5 text-red-400"></i>
                </div>
                <div class="min-w-0">
                  <p class="text-xs font-medium text-gray-300 truncate">세금계산서_안전모_50개.pdf</p>
                  <p class="text-[10px] text-gray-500">1.2MB | PDF</p>
                </div>
              </div>
              <div class="sample-doc border border-gray-700/50 rounded-xl p-4 flex items-center gap-3" data-doc="1" onclick="selectSampleDoc(1)">
                <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center flex-shrink-0">
                  <i data-lucide="image" class="w-5 h-5 text-amber-400"></i>
                </div>
                <div class="min-w-0">
                  <p class="text-xs font-medium text-gray-300 truncate">영수증_안전대_구매.jpg</p>
                  <p class="text-[10px] text-gray-500">850KB | JPG</p>
                </div>
              </div>
              <div class="sample-doc border border-gray-700/50 rounded-xl p-4 flex items-center gap-3" data-doc="2" onclick="selectSampleDoc(2)">
                <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center flex-shrink-0">
                  <i data-lucide="file-text" class="w-5 h-5 text-blue-400"></i>
                </div>
                <div class="min-w-0">
                  <p class="text-xs font-medium text-gray-300 truncate">거래명세서_안전화_100족.pdf</p>
                  <p class="text-[10px] text-gray-500">2.1MB | PDF</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Processing Queue (always visible) -->
      <div class="lg:col-span-1">
        <div class="card rounded-2xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-white flex items-center gap-2">
              <i data-lucide="list-checks" class="w-4 h-4 text-teal-400"></i>
              처리 대기열
            </h2>
            <span class="text-[10px] text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full" id="queueCount">12건</span>
          </div>

          <!-- Queue Stats -->
          <div class="grid grid-cols-4 gap-2 mb-4">
            <div class="text-center p-2 rounded-lg bg-gray-800/50">
              <p class="text-base font-bold text-white">47</p>
              <p class="text-[9px] text-gray-500">총 건수</p>
            </div>
            <div class="text-center p-2 rounded-lg bg-emerald-500/5 border border-emerald-500/10">
              <p class="text-base font-bold text-emerald-400">38</p>
              <p class="text-[9px] text-emerald-400/60">적합</p>
            </div>
            <div class="text-center p-2 rounded-lg bg-red-500/5 border border-red-500/10">
              <p class="text-base font-bold text-red-400">4</p>
              <p class="text-[9px] text-red-400/60">부적합</p>
            </div>
            <div class="text-center p-2 rounded-lg bg-amber-500/5 border border-amber-500/10">
              <p class="text-base font-bold text-amber-400">5</p>
              <p class="text-[9px] text-amber-400/60">보류</p>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
              <span>전체 진행률</span>
              <span>89.4%</span>
            </div>
            <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
              <div class="h-full rounded-full bg-gradient-to-r from-teal-500 to-emerald-400" style="width:89.4%"></div>
            </div>
          </div>

          <!-- Queue Items -->
          <div class="space-y-1.5 max-h-[400px] overflow-y-auto pr-1" id="queueList">
          </div>

          <!-- Download Button -->
          <div class="mt-4 pt-4 border-t border-gray-800">
            <button onclick="handleBatchDownload()" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-teal-600 to-emerald-600 text-white text-xs font-medium flex items-center justify-center gap-2 hover:from-teal-500 hover:to-emerald-500 transition-all">
              <i data-lucide="download" class="w-3.5 h-3.5"></i>
              일괄 결과 다운로드
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OCR Processing Section (shown after doc select) -->
  <div id="ocrSection" class="hidden">
    <!-- Processing Progress Bar -->
    <div id="processingBar" class="card rounded-xl p-4 mb-5 hidden">
      <div class="flex items-center gap-4">
        <div class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center">
          <i data-lucide="loader-2" class="w-4 h-4 text-teal-400 animate-spin"></i>
        </div>
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <span class="text-xs text-gray-300 font-medium" id="processStepText">OCR 문자 인식 중...</span>
            <span class="text-xs text-teal-400" id="processPercent">0%</span>
          </div>
          <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
            <div id="processProgressBar" class="h-full rounded-full bg-gradient-to-r from-teal-500 to-emerald-400 transition-all duration-500" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls Row -->
    <div class="flex items-center justify-between mb-5">
      <div class="flex items-center gap-3">
        <button onclick="goBackToUpload()" class="nav-btn flex items-center gap-2 text-xs text-gray-400 hover:text-teal-400 px-3 py-2 rounded-lg border border-gray-700/50">
          <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
          문서 선택
        </button>
        <div class="h-4 w-px bg-gray-700"></div>
        <span class="text-xs text-gray-500" id="currentDocName">세금계산서_안전모_50개.pdf</span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="reprocess()" class="nav-btn flex items-center gap-1.5 text-xs text-gray-400 hover:text-teal-400 px-3 py-2 rounded-lg border border-gray-700/50">
          <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
          재처리
        </button>
        <div class="flex rounded-lg border border-gray-700/50 overflow-hidden">
          <button onclick="switchSampleInView(0)" class="sample-switch px-3 py-2 text-[10px] text-gray-400 hover:text-white hover:bg-gray-700/50 transition-all" data-idx="0">세금계산서</button>
          <button onclick="switchSampleInView(1)" class="sample-switch px-3 py-2 text-[10px] text-gray-400 hover:text-white hover:bg-gray-700/50 transition-all border-x border-gray-700/50" data-idx="1">영수증</button>
          <button onclick="switchSampleInView(2)" class="sample-switch px-3 py-2 text-[10px] text-gray-400 hover:text-white hover:bg-gray-700/50 transition-all" data-idx="2">거래명세서</button>
        </div>
      </div>
    </div>

    <!-- Split View: Document Preview + Extracted Data -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">

      <!-- Left: Document Preview -->
      <div class="card rounded-2xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-white flex items-center gap-2">
            <i data-lucide="file-scan" class="w-4 h-4 text-teal-400"></i>
            문서 미리보기
          </h3>
          <span class="text-[10px] text-teal-400 bg-teal-500/10 px-2 py-0.5 rounded-full" id="ocrStatusBadge">분석 중</span>
        </div>
        <div class="receipt-mock rounded-xl p-6 relative min-h-[480px]" id="receiptPreview">
          <div id="scanLineEl" class="scan-line hidden"></div>
          <!-- OCR highlight boxes injected by JS -->
          <div id="ocrHighlights"></div>
          <!-- Receipt content injected by JS -->
          <div id="receiptContent"></div>
        </div>
      </div>

      <!-- Right: Extracted Data -->
      <div class="space-y-5">

        <!-- Extracted Fields -->
        <div class="card rounded-2xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
              <i data-lucide="braces" class="w-4 h-4 text-teal-400"></i>
              추출된 데이터
            </h3>
            <span class="text-[10px] text-gray-500">필드를 클릭하여 수정</span>
          </div>
          <div id="extractedFields" class="space-y-2.5">
            <!-- Populated by JS -->
          </div>
          <div class="mt-4 pt-3 border-t border-gray-800 flex items-center justify-between">
            <div class="flex items-center gap-2 text-[10px] text-gray-500">
              <i data-lucide="clock" class="w-3 h-3"></i>
              <span>처리시간: <span class="text-teal-400" id="processTime">-</span></span>
            </div>
            <div class="flex items-center gap-2 text-[10px] text-gray-500">
              <i data-lucide="cpu" class="w-3 h-3"></i>
              <span>신뢰도: <span class="text-emerald-400" id="confidenceVal">-</span></span>
            </div>
          </div>
        </div>

        <!-- QR Verification Panel -->
        <div class="card rounded-2xl p-5" id="qrPanel">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
              <i data-lucide="qr-code" class="w-4 h-4 text-teal-400"></i>
              QR 코드 진위 확인
            </h3>
            <span class="text-[10px] bg-gray-800 text-gray-500 px-2 py-0.5 rounded-full" id="qrStatusBadge">대기</span>
          </div>
          <div class="flex gap-5">
            <div class="flex-shrink-0">
              <div id="qrCodeDisplay" class="w-24 h-24 rounded-lg bg-white p-1.5 opacity-30">
                <div class="qr-grid w-full h-full" id="qrGrid"></div>
              </div>
            </div>
            <div class="flex-1 space-y-2" id="qrDetails">
              <p class="text-xs text-gray-500">QR 코드를 스캔하여 국세청 진위확인을 진행합니다.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Compliance Check -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-5">
      <div class="lg:col-span-2 card rounded-2xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-white flex items-center gap-2">
            <i data-lucide="brain-circuit" class="w-4 h-4 text-teal-400"></i>
            AI 기준 적합성 검토
          </h3>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full">GPT-4o 분석</span>
            <span class="text-[10px] bg-gray-800 text-gray-500 px-2 py-0.5 rounded-full" id="aiStatusBadge">대기</span>
          </div>
        </div>
        <div id="complianceChecklist" class="space-y-2.5">
          <!-- Populated by JS -->
        </div>

        <!-- Final Judgment -->
        <div id="finalJudgment" class="mt-5 pt-4 border-t border-gray-800 hidden">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div id="judgmentBadge" class="px-5 py-2.5 rounded-xl text-sm font-bold"></div>
              <div>
                <p class="text-xs text-gray-400" id="judgmentLabel">최종 판정</p>
                <p class="text-[10px] text-gray-500" id="judgmentSub"></p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500">종합 신뢰도</p>
              <p class="text-xl font-bold text-teal-400" id="overallConfidence">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Processing Queue (compact, in OCR view) -->
      <div class="card rounded-2xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-white flex items-center gap-2">
            <i data-lucide="list-checks" class="w-4 h-4 text-teal-400"></i>
            처리 현황
          </h3>
        </div>
        <div class="grid grid-cols-2 gap-2 mb-3">
          <div class="text-center p-2 rounded-lg bg-emerald-500/5 border border-emerald-500/10">
            <p class="text-lg font-bold text-emerald-400">38</p>
            <p class="text-[9px] text-emerald-400/60">적합</p>
          </div>
          <div class="text-center p-2 rounded-lg bg-red-500/5 border border-red-500/10">
            <p class="text-lg font-bold text-red-400">4</p>
            <p class="text-[9px] text-red-400/60">부적합</p>
          </div>
        </div>
        <div class="space-y-1.5 max-h-[260px] overflow-y-auto pr-1" id="queueListCompact"></div>
        <div class="mt-3 pt-3 border-t border-gray-800">
          <button onclick="handleBatchDownload()" class="w-full py-2 rounded-lg bg-gradient-to-r from-teal-600 to-emerald-600 text-white text-[11px] font-medium flex items-center justify-center gap-1.5 hover:from-teal-500 hover:to-emerald-500 transition-all">
            <i data-lucide="download" class="w-3 h-3"></i>
            일괄 결과 다운로드
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
  <div class="card rounded-xl px-5 py-3 flex items-center gap-3 shadow-2xl border-teal-500/30">
    <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
    <span class="text-sm text-gray-200" id="toastText"></span>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const sampleDocuments = [
  {
    name: '세금계산서_안전모_50개.pdf',
    type: '세금계산서',
    fields: [
      { label: '문서유형', value: '전자세금계산서', icon: 'file-text' },
      { label: '업체명', value: '㈜한국안전관리', icon: 'building-2' },
      { label: '사업자번호', value: '123-45-67890', icon: 'hash' },
      { label: '품목', value: '안전모 (산업용) 50개', icon: 'package' },
      { label: '공급가액', value: '1,136,364원', icon: 'banknote' },
      { label: '부가세', value: '113,636원', icon: 'receipt' },
      { label: '합계금액', value: '1,250,000원', icon: 'calculator' },
      { label: '발행일', value: '2025-01-15', icon: 'calendar' }
    ],
    receipt: {
      title: '전 자 세 금 계 산 서',
      header: '(공급자용)',
      rows: [
        ['공급자', '㈜한국안전관리', '등록번호', '123-45-67890'],
        ['상호', '한국안전관리', '성명', '김대표'],
        ['사업장주소', '서울특별시 강남구 테헤란로 123', '', ''],
        ['업태', '제조업', '종목', '안전장비'],
      ],
      items: [
        { date: '01/15', item: '안전모 (산업용)', spec: 'KS규격', qty: '50', price: '22,727', amount: '1,136,364' }
      ],
      supply: '1,136,364',
      tax: '113,636',
      total: '1,250,000'
    },
    qr: {
      issueNo: '2025-0115-41892734',
      issueDate: '2025-01-15',
      supplier: '㈜한국안전관리',
      receiver: '㈜대한건설',
      result: 'authentic'
    },
    compliance: [
      { text: '품목이 안전관리비 허용 항목에 해당', pass: true },
      { text: '금액이 기준 단가 이내 (안전모 1개당 ≤25,000원)', pass: true },
      { text: '발행일이 공사기간 내 (2024.09~2025.08)', pass: true },
      { text: '업체 등록증 미확인 → 추가 확인 필요', pass: false },
    ],
    judgment: '보류',
    confidence: 94.7
  },
  {
    name: '영수증_안전대_구매.jpg',
    type: '영수증',
    fields: [
      { label: '문서유형', value: '간이영수증', icon: 'file-text' },
      { label: '업체명', value: '안전장비마트', icon: 'building-2' },
      { label: '사업자번호', value: '456-78-90123', icon: 'hash' },
      { label: '품목', value: '안전대 (전신형) 20개', icon: 'package' },
      { label: '공급가액', value: '3,600,000원', icon: 'banknote' },
      { label: '부가세', value: '360,000원', icon: 'receipt' },
      { label: '합계금액', value: '3,960,000원', icon: 'calculator' },
      { label: '발행일', value: '2025-02-20', icon: 'calendar' }
    ],
    receipt: {
      title: '영  수  증',
      header: '',
      rows: [
        ['상호', '안전장비마트', '사업자번호', '456-78-90123'],
        ['대표자', '박안전', '연락처', '02-555-1234'],
        ['주소', '서울시 영등포구 문래동 42-7', '', ''],
      ],
      items: [
        { date: '02/20', item: '안전대 (전신형)', spec: 'KC인증', qty: '20', price: '180,000', amount: '3,600,000' }
      ],
      supply: '3,600,000',
      tax: '360,000',
      total: '3,960,000'
    },
    qr: {
      issueNo: '2025-0220-58371942',
      issueDate: '2025-02-20',
      supplier: '안전장비마트',
      receiver: '㈜대한건설',
      result: 'authentic'
    },
    compliance: [
      { text: '품목이 안전관리비 허용 항목에 해당', pass: true },
      { text: '금액이 기준 단가 이내 (안전대 1개당 ≤200,000원)', pass: true },
      { text: '발행일이 공사기간 내 (2024.09~2025.08)', pass: true },
      { text: '업체 등록증 확인 완료', pass: true },
    ],
    judgment: '적합',
    confidence: 98.2
  },
  {
    name: '거래명세서_안전화_100족.pdf',
    type: '거래명세서',
    fields: [
      { label: '문서유형', value: '거래명세서', icon: 'file-text' },
      { label: '업체명', value: '㈜세이프슈즈', icon: 'building-2' },
      { label: '사업자번호', value: '789-01-23456', icon: 'hash' },
      { label: '품목', value: '안전화 (KS인증) 100족', icon: 'package' },
      { label: '공급가액', value: '4,545,455원', icon: 'banknote' },
      { label: '부가세', value: '454,545원', icon: 'receipt' },
      { label: '합계금액', value: '5,000,000원', icon: 'calculator' },
      { label: '발행일', value: '2025-03-10', icon: 'calendar' }
    ],
    receipt: {
      title: '거 래 명 세 서',
      header: '(공급자 보관용)',
      rows: [
        ['공급자', '㈜세이프슈즈', '등록번호', '789-01-23456'],
        ['상호', '세이프슈즈', '성명', '이안전'],
        ['주소', '부산광역시 사상구 학장동 567', '', ''],
        ['업태', '제조/도매', '종목', '안전화'],
      ],
      items: [
        { date: '03/10', item: '안전화 (KS인증)', spec: 'KS표준', qty: '100', price: '45,455', amount: '4,545,455' }
      ],
      supply: '4,545,455',
      tax: '454,545',
      total: '5,000,000'
    },
    qr: {
      issueNo: '2025-0310-73918264',
      issueDate: '2025-03-10',
      supplier: '㈜세이프슈즈',
      receiver: '㈜대한건설',
      result: 'suspect'
    },
    compliance: [
      { text: '품목이 안전관리비 허용 항목에 해당', pass: true },
      { text: '금액이 기준 단가 초과 (안전화 1개당 ≤40,000원 기준 초과)', pass: false },
      { text: '발행일이 공사기간 내 (2024.09~2025.08)', pass: true },
      { text: '업체 등록증 확인 완료', pass: true },
    ],
    judgment: '부적합',
    confidence: 72.3
  }
];

const queueItems = [
  { name: '세금계산서_안전모_50개.pdf', status: '처리완료', type: 'success' },
  { name: '영수증_안전대_구매.jpg', status: '처리완료', type: 'success' },
  { name: '거래명세서_안전화_100족.pdf', status: '부적합', type: 'error' },
  { name: '세금계산서_안전장갑_200켤레.pdf', status: '처리완료', type: 'success' },
  { name: '영수증_보안경_30개.jpg', status: '처리완료', type: 'success' },
  { name: '세금계산서_안전조끼_100벌.pdf', status: '검토중', type: 'warning' },
  { name: '영수증_귀마개_500개.jpg', status: '처리완료', type: 'success' },
  { name: '거래명세서_방진마스크_1000개.pdf', status: '보류', type: 'hold' },
  { name: '세금계산서_안전표지판_20개.pdf', status: '처리완료', type: 'success' },
  { name: '영수증_소화기_15대.jpg', status: '처리완료', type: 'success' },
  { name: '거래명세서_안전난간_50m.pdf', status: '보류', type: 'hold' },
  { name: '세금계산서_보호복_30벌.pdf', status: '검토중', type: 'warning' },
  { name: '영수증_안전벨트_25개.jpg', status: '부적합', type: 'error' },
  { name: '세금계산서_안전망_200m.pdf', status: '처리완료', type: 'success' },
  { name: '거래명세서_구급함_10개.pdf', status: '처리완료', type: 'success' },
];

// ============================================================
// STATE
// ============================================================
let currentDocIndex = -1;
let isProcessing = false;
let editingField = null;

// ============================================================
// INITIALIZATION
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  renderQueueList('queueList');
  renderQueueList('queueListCompact');
  generateQRGrid();
});

// ============================================================
// QUEUE RENDERING
// ============================================================
function renderQueueList(containerId) {
  const container = document.getElementById(containerId);
  const statusColors = {
    success: { bg: 'bg-emerald-500/10', text: 'text-emerald-400', border: 'border-emerald-500/20' },
    error: { bg: 'bg-red-500/10', text: 'text-red-400', border: 'border-red-500/20' },
    warning: { bg: 'bg-amber-500/10', text: 'text-amber-400', border: 'border-amber-500/20' },
    hold: { bg: 'bg-orange-500/10', text: 'text-orange-400', border: 'border-orange-500/20' }
  };

  container.innerHTML = queueItems.map((item, i) => {
    const c = statusColors[item.type];
    return `
      <div class="flex items-center justify-between py-2 px-3 rounded-lg hover:bg-gray-800/40 transition-all group cursor-pointer" onclick="showToast('${item.name} 상세정보 표시')">
        <div class="flex items-center gap-2 min-w-0 flex-1">
          <span class="w-5 h-5 rounded flex items-center justify-center flex-shrink-0 ${c.bg}">
            <span class="text-[9px] ${c.text}">${i + 1}</span>
          </span>
          <span class="text-[11px] text-gray-400 truncate">${item.name}</span>
        </div>
        <span class="status-badge ${c.bg} ${c.text} border ${c.border} flex-shrink-0 ml-2">${item.status}</span>
      </div>
    `;
  }).join('');
}

// ============================================================
// QR CODE GENERATION (CSS mock)
// ============================================================
function generateQRGrid() {
  const grid = document.getElementById('qrGrid');
  // Deterministic "random" QR-like pattern
  const seed = [1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,
                1,0,0,0,0,0,1,0,0,1,0,0,1,0,1,
                1,0,1,1,1,0,1,0,1,1,0,1,1,0,0,
                1,0,1,1,1,0,1,0,0,0,1,0,1,1,1,
                1,0,1,1,1,0,1,0,1,0,0,1,0,0,1,
                1,0,0,0,0,0,1,0,0,1,1,0,1,0,0,
                1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,
                0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,
                1,0,1,0,1,1,1,1,0,0,1,1,0,1,1,
                0,1,0,1,0,0,0,1,1,0,0,1,0,1,0,
                1,1,0,0,1,0,1,0,1,1,1,0,1,0,1,
                0,0,0,1,0,1,0,0,0,1,0,1,0,0,1,
                1,1,1,1,1,1,1,0,1,0,1,1,1,0,0,
                1,0,0,0,0,0,1,0,0,1,0,0,0,1,1,
                1,0,1,1,1,0,1,0,1,0,1,0,1,0,1];

  grid.innerHTML = seed.map(v =>
    `<div class="qr-cell" style="background:${v ? '#000' : '#fff'}"></div>`
  ).join('');
}

// ============================================================
// DOCUMENT SELECTION & OCR ANIMATION
// ============================================================
function selectSampleDoc(index) {
  if (isProcessing) return;
  currentDocIndex = index;

  // Highlight active sample
  document.querySelectorAll('.sample-doc').forEach((el, i) => {
    el.classList.toggle('active', i === index);
  });

  // Switch to OCR view
  document.getElementById('uploadSection').classList.add('hidden');
  document.getElementById('ocrSection').classList.remove('hidden');

  // Highlight active switch button
  document.querySelectorAll('.sample-switch').forEach((btn, i) => {
    btn.classList.toggle('text-teal-400', i === index);
    btn.classList.toggle('bg-teal-500/10', i === index);
  });

  // Set document name
  document.getElementById('currentDocName').textContent = sampleDocuments[index].name;

  // Reset and run OCR
  runOCRAnimation(index);
  lucide.createIcons();
}

function switchSampleInView(index) {
  if (isProcessing) return;
  currentDocIndex = index;

  document.querySelectorAll('.sample-switch').forEach((btn, i) => {
    btn.classList.toggle('text-teal-400', i === index);
    btn.classList.toggle('bg-teal-500/10', i === index);
  });
  document.getElementById('currentDocName').textContent = sampleDocuments[index].name;

  runOCRAnimation(index);
}

function goBackToUpload() {
  if (isProcessing) return;
  document.getElementById('uploadSection').classList.remove('hidden');
  document.getElementById('ocrSection').classList.add('hidden');
}

function reprocess() {
  if (isProcessing || currentDocIndex < 0) return;
  runOCRAnimation(currentDocIndex);
}

// ============================================================
// OCR ANIMATION ENGINE
// ============================================================
async function runOCRAnimation(docIndex) {
  isProcessing = true;
  const doc = sampleDocuments[docIndex];

  // Reset UI
  resetOCRView();

  // Show processing bar
  const procBar = document.getElementById('processingBar');
  procBar.classList.remove('hidden');

  // Phase 1: Render receipt
  renderReceipt(doc);

  // Phase 2: Show scan line
  const scanLine = document.getElementById('scanLineEl');
  scanLine.classList.remove('hidden');

  // Phase 3: Progress simulation
  const steps = [
    { text: '문서 이미지 전처리 중...', pct: 15 },
    { text: 'OCR 문자 인식 중...', pct: 35 },
    { text: '필드 구조 분석 중...', pct: 55 },
    { text: '데이터 추출 중...', pct: 75 },
    { text: 'QR 코드 검증 중...', pct: 88 },
    { text: 'AI 적합성 분석 중...', pct: 100 },
  ];

  const startTime = performance.now();

  for (let i = 0; i < steps.length; i++) {
    document.getElementById('processStepText').textContent = steps[i].text;
    document.getElementById('processPercent').textContent = steps[i].pct + '%';
    document.getElementById('processProgressBar').style.width = steps[i].pct + '%';

    // Animate OCR highlights at certain steps
    if (i === 2) {
      animateOCRHighlights(doc);
    }
    if (i === 3) {
      animateExtractedFields(doc);
    }
    if (i === 4) {
      animateQRVerification(doc);
    }
    if (i === 5) {
      animateComplianceCheck(doc);
    }

    await sleep(600 + Math.random() * 400);
  }

  // Complete
  const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
  document.getElementById('processTime').textContent = elapsed + '초';
  document.getElementById('confidenceVal').textContent = doc.confidence + '%';
  document.getElementById('ocrStatusBadge').textContent = '완료';
  document.getElementById('ocrStatusBadge').className = 'text-[10px] text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded-full';

  scanLine.classList.add('hidden');
  procBar.classList.add('hidden');

  isProcessing = false;
  lucide.createIcons();
}

function resetOCRView() {
  document.getElementById('extractedFields').innerHTML = '';
  document.getElementById('ocrHighlights').innerHTML = '';
  document.getElementById('complianceChecklist').innerHTML = '';
  document.getElementById('finalJudgment').classList.add('hidden');
  document.getElementById('ocrStatusBadge').textContent = '분석 중';
  document.getElementById('ocrStatusBadge').className = 'text-[10px] text-teal-400 bg-teal-500/10 px-2 py-0.5 rounded-full';
  document.getElementById('qrStatusBadge').textContent = '대기';
  document.getElementById('qrStatusBadge').className = 'text-[10px] bg-gray-800 text-gray-500 px-2 py-0.5 rounded-full';
  document.getElementById('aiStatusBadge').textContent = '대기';
  document.getElementById('aiStatusBadge').className = 'text-[10px] bg-gray-800 text-gray-500 px-2 py-0.5 rounded-full';
  document.getElementById('qrCodeDisplay').classList.add('opacity-30');
  document.getElementById('qrDetails').innerHTML = '<p class="text-xs text-gray-500">QR 코드를 스캔하여 국세청 진위확인을 진행합니다.</p>';
  document.getElementById('processTime').textContent = '-';
  document.getElementById('confidenceVal').textContent = '-';
  document.getElementById('processProgressBar').style.width = '0%';
}

// ============================================================
// RECEIPT RENDERING
// ============================================================
function renderReceipt(doc) {
  const r = doc.receipt;
  const el = document.getElementById('receiptContent');

  let tableRows = r.rows.map(row => {
    if (row[2] && row[3]) {
      return `<tr>
        <td class="border border-gray-400 px-2 py-1 bg-gray-200 text-[10px] font-semibold text-gray-600 w-16">${row[0]}</td>
        <td class="border border-gray-400 px-2 py-1 text-[11px] text-gray-800">${row[1]}</td>
        <td class="border border-gray-400 px-2 py-1 bg-gray-200 text-[10px] font-semibold text-gray-600 w-16">${row[2]}</td>
        <td class="border border-gray-400 px-2 py-1 text-[11px] text-gray-800">${row[3]}</td>
      </tr>`;
    } else {
      return `<tr>
        <td class="border border-gray-400 px-2 py-1 bg-gray-200 text-[10px] font-semibold text-gray-600 w-16">${row[0]}</td>
        <td colspan="3" class="border border-gray-400 px-2 py-1 text-[11px] text-gray-800">${row[1]}</td>
      </tr>`;
    }
  }).join('');

  let itemRows = r.items.map(item => `
    <tr>
      <td class="border border-gray-400 px-2 py-1 text-[10px] text-gray-700 text-center">${item.date}</td>
      <td class="border border-gray-400 px-2 py-1 text-[10px] text-gray-800 font-medium">${item.item}</td>
      <td class="border border-gray-400 px-2 py-1 text-[10px] text-gray-700 text-center">${item.spec}</td>
      <td class="border border-gray-400 px-2 py-1 text-[10px] text-gray-700 text-right">${item.qty}</td>
      <td class="border border-gray-400 px-2 py-1 text-[10px] text-gray-700 text-right">${item.price}</td>
      <td class="border border-gray-400 px-2 py-1 text-[10px] text-gray-800 font-medium text-right">${item.amount}</td>
    </tr>
  `).join('');

  el.innerHTML = `
    <div class="text-center mb-4 relative z-20">
      <h2 class="text-lg font-bold text-gray-800 tracking-widest">${r.title}</h2>
      ${r.header ? `<p class="text-[10px] text-gray-500">${r.header}</p>` : ''}
    </div>
    <table class="w-full border-collapse mb-3 relative z-20">
      ${tableRows}
    </table>
    <table class="w-full border-collapse mb-3 relative z-20">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-400 px-2 py-1 text-[9px] text-gray-600 w-12">일자</th>
          <th class="border border-gray-400 px-2 py-1 text-[9px] text-gray-600">품목</th>
          <th class="border border-gray-400 px-2 py-1 text-[9px] text-gray-600 w-14">규격</th>
          <th class="border border-gray-400 px-2 py-1 text-[9px] text-gray-600 w-10">수량</th>
          <th class="border border-gray-400 px-2 py-1 text-[9px] text-gray-600 w-16">단가</th>
          <th class="border border-gray-400 px-2 py-1 text-[9px] text-gray-600 w-20">금액</th>
        </tr>
      </thead>
      <tbody>
        ${itemRows}
      </tbody>
    </table>
    <div class="relative z-20">
      <table class="w-full border-collapse">
        <tr>
          <td class="border border-gray-400 px-2 py-1 bg-gray-200 text-[10px] font-semibold text-gray-600 w-20">공급가액</td>
          <td class="border border-gray-400 px-2 py-1 text-[11px] text-gray-800 text-right font-bold">${r.supply}원</td>
          <td class="border border-gray-400 px-2 py-1 bg-gray-200 text-[10px] font-semibold text-gray-600 w-16">세액</td>
          <td class="border border-gray-400 px-2 py-1 text-[11px] text-gray-800 text-right font-bold">${r.tax}원</td>
        </tr>
        <tr>
          <td class="border border-gray-400 px-2 py-1.5 bg-blue-100 text-[10px] font-bold text-gray-700" colspan="1">합계</td>
          <td class="border border-gray-400 px-2 py-1.5 bg-blue-50 text-sm text-blue-800 text-right font-black" colspan="3">${r.total}원</td>
        </tr>
      </table>
    </div>
    <div class="mt-4 flex items-center justify-between relative z-20">
      <div class="text-[9px] text-gray-400">위 금액을 영수(청구) 함</div>
      <div class="w-12 h-12 rounded-full border-2 border-red-400 flex items-center justify-center rotate-[-12deg] opacity-50">
        <span class="text-[8px] text-red-400 font-bold">인</span>
      </div>
    </div>
  `;
}

// ============================================================
// OCR HIGHLIGHT BOXES
// ============================================================
function animateOCRHighlights(doc) {
  const container = document.getElementById('ocrHighlights');
  // Position highlights over key areas (approximate positions on the mock receipt)
  const positions = [
    { top: '12%', left: '10%', width: '80%', height: '8%', delay: 0 },
    { top: '23%', left: '25%', width: '25%', height: '5%', delay: 200 },
    { top: '23%', left: '70%', width: '25%', height: '5%', delay: 350 },
    { top: '55%', left: '15%', width: '30%', height: '5%', delay: 500 },
    { top: '55%', left: '72%', width: '22%', height: '5%', delay: 650 },
    { top: '75%', left: '52%', width: '42%', height: '7%', delay: 800 },
    { top: '84%', left: '52%', width: '42%', height: '7%', delay: 950 },
  ];

  positions.forEach(pos => {
    setTimeout(() => {
      const highlight = document.createElement('div');
      highlight.className = 'ocr-highlight';
      highlight.style.cssText = `top:${pos.top};left:${pos.left};width:${pos.width};height:${pos.height};`;
      container.appendChild(highlight);
    }, pos.delay);
  });
}

// ============================================================
// EXTRACTED FIELDS ANIMATION
// ============================================================
function animateExtractedFields(doc) {
  const container = document.getElementById('extractedFields');
  container.innerHTML = '';

  doc.fields.forEach((field, i) => {
    setTimeout(() => {
      const row = document.createElement('div');
      row.className = 'fade-in-up flex items-center justify-between py-2 px-3 rounded-lg bg-gray-800/30 hover:bg-gray-800/50 transition-all';
      row.style.animationDelay = `${i * 0.05}s`;

      row.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-7 h-7 rounded-md bg-teal-500/10 flex items-center justify-center">
            <i data-lucide="${field.icon}" class="w-3.5 h-3.5 text-teal-400"></i>
          </div>
          <span class="text-xs text-gray-500 w-20">${field.label}</span>
        </div>
        <div class="editable-field text-sm text-gray-200 font-medium" onclick="makeEditable(this, ${docIndex}, ${i})" data-field="${i}" data-original="${field.value}">
          ${field.value}
        </div>
      `;

      container.appendChild(row);
      lucide.createIcons();
    }, i * 120);
  });
}

// ============================================================
// EDITABLE FIELDS
// ============================================================
function makeEditable(el, docIdx, fieldIdx) {
  if (isProcessing) return;
  if (el.querySelector('input')) return;

  const currentVal = el.dataset.original || el.textContent.trim();
  el.innerHTML = `<input type="text" value="${currentVal}" onblur="saveField(this, ${fieldIdx})" onkeydown="if(event.key==='Enter')this.blur()">`;
  const input = el.querySelector('input');
  input.focus();
  input.select();
}

function saveField(input, fieldIdx) {
  const el = input.parentElement;
  const newVal = input.value.trim();
  el.dataset.original = newVal;
  el.innerHTML = newVal;
  showToast('필드가 수정되었습니다: ' + newVal);
}

// ============================================================
// QR VERIFICATION ANIMATION
// ============================================================
async function animateQRVerification(doc) {
  const badge = document.getElementById('qrStatusBadge');
  const display = document.getElementById('qrCodeDisplay');
  const details = document.getElementById('qrDetails');
  const qr = doc.qr;

  // Phase 1: scanning
  badge.textContent = '검증 중';
  badge.className = 'text-[10px] bg-amber-500/10 text-amber-400 px-2 py-0.5 rounded-full';
  display.classList.remove('opacity-30');
  display.style.animation = 'qrReveal 0.5s ease forwards';

  details.innerHTML = `
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full border-2 border-t-teal-400 border-gray-700 animate-spin"></div>
      <span class="text-xs text-teal-400">국세청 진위확인 중...</span>
    </div>
  `;

  await sleep(800);

  // Phase 2: result
  const isAuthentic = qr.result === 'authentic';
  badge.textContent = isAuthentic ? '진본확인' : '위변조 의심';
  badge.className = isAuthentic
    ? 'text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded-full'
    : 'text-[10px] bg-red-500/10 text-red-400 px-2 py-0.5 rounded-full';

  const checkIcon = isAuthentic
    ? '<div class="w-5 h-5 rounded-full bg-emerald-500/20 flex items-center justify-center"><i data-lucide="check" class="w-3 h-3 text-emerald-400"></i></div>'
    : '<div class="w-5 h-5 rounded-full bg-red-500/20 flex items-center justify-center"><i data-lucide="x" class="w-3 h-3 text-red-400"></i></div>';

  const resultText = isAuthentic
    ? '<span class="text-emerald-400 font-medium">국세청 일치 확인</span>'
    : '<span class="text-red-400 font-medium">위변조 의심</span>';

  details.innerHTML = `
    <div class="slide-in-right flex items-center gap-2 mb-3">
      ${checkIcon}
      <span class="text-xs">${resultText}</span>
    </div>
    <div class="space-y-1.5 text-[11px]">
      <div class="slide-in-right flex justify-between" style="animation-delay:0.1s">
        <span class="text-gray-500">발행번호</span>
        <span class="text-gray-300 font-mono text-[10px]">${qr.issueNo}</span>
      </div>
      <div class="slide-in-right flex justify-between" style="animation-delay:0.15s">
        <span class="text-gray-500">발행일</span>
        <span class="text-gray-300">${qr.issueDate}</span>
      </div>
      <div class="slide-in-right flex justify-between" style="animation-delay:0.2s">
        <span class="text-gray-500">공급자</span>
        <span class="text-gray-300">${qr.supplier}</span>
      </div>
      <div class="slide-in-right flex justify-between" style="animation-delay:0.25s">
        <span class="text-gray-500">공급받는자</span>
        <span class="text-gray-300">${qr.receiver}</span>
      </div>
    </div>
    <div class="mt-3 pt-2 border-t border-gray-700/50">
      <div class="slide-in-right flex items-center justify-center gap-2 py-1.5 rounded-lg ${isAuthentic ? 'bg-emerald-500/10' : 'bg-red-500/10'}" style="animation-delay:0.3s">
        <span class="text-xs font-bold ${isAuthentic ? 'text-emerald-400' : 'text-red-400'}">${isAuthentic ? '진본확인' : '위변조 의심'}</span>
      </div>
    </div>
  `;

  lucide.createIcons();
}

// ============================================================
// AI COMPLIANCE CHECK ANIMATION
// ============================================================
async function animateComplianceCheck(doc) {
  const container = document.getElementById('complianceChecklist');
  const aiBadge = document.getElementById('aiStatusBadge');

  aiBadge.textContent = '분석 중';
  aiBadge.className = 'text-[10px] bg-teal-500/10 text-teal-400 px-2 py-0.5 rounded-full';

  container.innerHTML = '';

  for (let i = 0; i < doc.compliance.length; i++) {
    const check = doc.compliance[i];
    await sleep(350);

    const item = document.createElement('div');
    item.className = 'fade-in-up flex items-start gap-3 py-2.5 px-3 rounded-lg ' +
      (check.pass ? 'bg-emerald-500/5' : 'bg-red-500/5');

    item.innerHTML = `
      <div class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 ${check.pass ? 'bg-emerald-500/20' : 'bg-red-500/20'}">
        <i data-lucide="${check.pass ? 'check' : 'x'}" class="w-3 h-3 ${check.pass ? 'text-emerald-400' : 'text-red-400'}"></i>
      </div>
      <div class="flex-1">
        <p class="text-xs ${check.pass ? 'text-gray-300' : 'text-red-300'}">${check.text}</p>
      </div>
      <span class="text-[9px] px-2 py-0.5 rounded-full flex-shrink-0 ${check.pass ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}">
        ${check.pass ? '통과' : '미통과'}
      </span>
    `;

    container.appendChild(item);
    lucide.createIcons();
  }

  // Show final judgment
  await sleep(500);
  aiBadge.textContent = '완료';
  aiBadge.className = 'text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded-full';

  const judgment = document.getElementById('finalJudgment');
  const judgmentBadge = document.getElementById('judgmentBadge');
  const judgmentSub = document.getElementById('judgmentSub');
  const overallConf = document.getElementById('overallConfidence');

  judgment.classList.remove('hidden');
  judgment.classList.add('fade-in-up');

  const jColors = {
    '적합': { bg: 'bg-emerald-500', text: 'text-white', sub: '모든 기준 항목을 충족합니다' },
    '부적합': { bg: 'bg-red-500', text: 'text-white', sub: '기준 초과 항목이 발견되었습니다' },
    '보류': { bg: 'bg-amber-500', text: 'text-gray-900', sub: '추가 확인이 필요한 항목이 있습니다' }
  };

  const jc = jColors[doc.judgment];
  judgmentBadge.className = `px-5 py-2.5 rounded-xl text-sm font-bold ${jc.bg} ${jc.text}`;
  judgmentBadge.textContent = doc.judgment;
  judgmentSub.textContent = jc.sub;
  overallConf.textContent = doc.confidence + '%';
}

// ============================================================
// UTILITIES
// ============================================================
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function showToast(text) {
  const toast = document.getElementById('toast');
  document.getElementById('toastText').textContent = text;
  toast.classList.remove('hidden');
  setTimeout(() => toast.classList.add('hidden'), 2500);
}

function handleBatchDownload() {
  showToast('일괄 결과 파일을 생성 중입니다...');
  setTimeout(() => {
    showToast('47건 처리 결과가 다운로드되었습니다 (Excel)');
  }, 1500);
}
</script>
</body>
</html>
